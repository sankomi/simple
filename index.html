<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="robots" content="noindex">
		<title id="title">{{username}}</title>

		<style>
			* {box-sizing: border-box;}
			html {font-family: monospace;}
			body {max-width: 60rem; padding: 1rem; margin: 0 auto;}
			ul {padding: 0; list-style-type: none;}
		</style>
		<script src="simple.js"></script>
	</head>
	<body>
		<h1 id="h1">{{username}}</h1>
		<div id="list" style="{{styles.list}}">
			<template for="messages">
				<p>{{message}}</p>
			</template>
			<ul>
				<template for="repos">
					<li>
						<h2>
							<a href="{{url}}">{{name}}</a>
						</h2>
						<p>{{description}}</p>
					</li>
				</template>
			</ul>
			<div>
				<a id="prev" href="" onclick="{{showPrev}}" style="{{styles.prev}}">prev</a>
				<a id="next" href="" onclick="{{showNext}}" style="{{styles.next}}">next</a>
			</div>
		</div>

		<script>
			const USERNAME = "sankomi";

			simplify(document.getElementById("title")).username = USERNAME;
			simplify(document.getElementById("h1")).username = USERNAME;

			const list = simplify(document.getElementById("list"));

			list.styles = {
				list: {transition: "opacity 0.2s", opacity: 1},
				next: {transition: "opacity 0.2s", opacity: 1},
				prev: {transition: "opacity 0.2s", opacity: 1},
			};
			list.showPrev = event => {
				event.preventDefault();
				if (list.prevLink) {
					fetchRepos(list.prevLink);
				}
			}
			list.showNext = event => {
				event.preventDefault();
				if (list.nextLink) {
					fetchRepos(list.nextLink);
				}
			}

			let page = 1;
			let fetching = false;
			fetchRepos(`https://api.github.com/users/${USERNAME}/repos?sort=pushed&direction=desc&per_page=5&page=${page}`);

			function fetchRepos(link) {
				if (fetching) return;
				fetching = true;

				list.styles.list.opacity = 0.2;
				list.prevLink = null;
				list.nextLink = null;

				fetch(link, {headers: {accept: "application/vnd.github+json"}})
					.then(res => {
						if (res.status === 200) {
							const links = res.headers.get("link");
							return res.json()
								.then(json => ({links, json}));
						} else {
							throw new Error();
						}
					})
					.then(({links, json}) => {
						list.repos.length = 0;
						json.forEach(item => {
							list.repos.push({
								name: item.name,
								description: item.description,
								url: item["html_url"],
							});
						});

						const split = links.split(",");
						split.forEach(string => {
							const split = string.split(";");
							if (split.length !== 2) return;

							const name = split[1].trim().replaceAll(/(rel=)|"/g, "");
							const link = split[0].trim().replaceAll(/<|>/g, "");

							if (name === "prev") list.prevLink = link;
							else if (name === "next") list.nextLink = link;
						});

						list.styles.prev.opacity = list.prevLink? 1: 0.2;
						list.styles.next.opacity = list.nextLink? 1: 0.2;
					})
					.catch(err => {
						list.messages.push({message: "failed to fetch"});
					})
					.finally(() => {
						list.styles.list.opacity = 1;
						fetching = false;
					});
			}
		</script>
	</body>
</html>
